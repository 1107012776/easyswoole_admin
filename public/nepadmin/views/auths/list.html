<style>
    .cf:after {
        visibility: hidden;
        display: block;
        font-size: 0;
        content: " ";
        clear: both;
        height: 0
    }

    * html .cf {
        zoom: 1
    }

    *:first-child + html .cf {
        zoom: 1
    }

    html {
        margin: 0;
        padding: 0
    }

    h1 {
        font-size: 1.75em;
        margin: 0 0 .6em 0
    }

    a {
        color: #2996cc
    }

    a:hover {
        text-decoration: none
    }

    p {
        line-height: 1.5em
    }

    .small {
        color: #666;
        font-size: .875em
    }

    .large {
        font-size: 1.25em
    }

    .dd {
        position: relative;
        display: block;
        margin: 0;
        padding: 0;
        max-width: 600px;
        list-style: none;
        font-size: 13px;
        line-height: 20px
    }

    .dd-list {
        display: block;
        position: relative;
        margin: 0;
        padding: 0;
        list-style: none
    }

    .dd-list .dd-list {
        padding-left: 30px
    }

    .dd-collapsed .dd-list {
        display: none
    }

    .dd-item, .dd-empty, .dd-placeholder {
        display: block;
        position: relative;
        margin: 0;
        padding: 0;
        min-height: 20px;
        font-size: 13px;
        line-height: 20px
    }

    .dd-handle {
        display: block;
        height: 30px;
        margin: 5px 0;
        padding: 5px 10px;
        color: #333;
        text-decoration: none;
        font-weight: bold;
        border: 1px solid #ccc;
        background: #fafafa;
        background: -webkit-linear-gradient(top, #fafafa 0, #eee 100%);
        background: -moz-linear-gradient(top, #fafafa 0, #eee 100%);
        background: linear-gradient(top, #fafafa 0, #eee 100%);
        -webkit-border-radius: 3px;
        border-radius: 3px;
        box-sizing: border-box;
        -moz-box-sizing: border-box
    }

    .dd-handle:hover {
        color: #2ea8e5;
        background: #fff
    }

    .dd-item > button {
        display: block;
        position: relative;
        cursor: pointer;
        float: left;
        width: 25px;
        height: 20px;
        margin: 5px 0;
        padding: 0;
        text-indent: 100%;
        white-space: nowrap;
        overflow: hidden;
        border: 0;
        background: transparent;
        font-size: 12px;
        line-height: 1;
        text-align: center;
        font-weight: bold
    }

    .dd-item > button:before {
        content: '+';
        display: block;
        position: absolute;
        width: 100%;
        text-align: center;
        text-indent: 0
    }

    .dd-item > button[data-action="collapse"]:before {
        content: '-'
    }

    .dd-placeholder, .dd-empty {
        margin: 5px 0;
        padding: 0;
        min-height: 30px;
        background: #f2fbff;
        border: 1px dashed #b6bcbf;
        box-sizing: border-box;
        -moz-box-sizing: border-box
    }

    .dd-empty {
        border: 1px dashed #bbb;
        min-height: 100px;
        background-color: #e5e5e5;
        background-image: -webkit-linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff), -webkit-linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff);
        background-image: -moz-linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff), -moz-linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff);
        background-image: linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff), linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%, #fff);
        background-size: 60px 60px;
        background-position: 0 0, 30px 30px
    }

    .dd-dragel {
        position: absolute;
        pointer-events: none;
        z-index: 9999
    }

    .dd-dragel > .dd-item .dd-handle {
        margin-top: 0
    }

    .dd-dragel .dd-handle {
        -webkit-box-shadow: 2px 4px 6px 0 rgba(0, 0, 0, .1);
        box-shadow: 2px 4px 6px 0 rgba(0, 0, 0, .1)
    }

    .nestable-lists {
        display: block;
        clear: both;
        padding: 30px 0;
        width: 100%;
        border: 0;
    }

    #nestable-menu {
        padding: 0;
        margin: 20px 0
    }

    #nestable-output, #nestable2-output {
        width: 100%;
        height: 7em;
        font-size: .75em;
        line-height: 1.333333em;
        font-family: Consolas, monospace;
        padding: 5px;
        box-sizing: border-box;
        -moz-box-sizing: border-box
    }

    #nestable2 .dd-handle {
        color: #fff;
        border: 1px solid #999;
        background: #bbb;
        background: -webkit-linear-gradient(top, #bbb 0, #999 100%);
        background: -moz-linear-gradient(top, #bbb 0, #999 100%);
        background: linear-gradient(top, #bbb 0, #999 100%)
    }

    #nestable2 .dd-handle:hover {
        background: #bbb
    }

    #nestable2 .dd-item > button:before {
        color: #fff
    }

    @media only screen and (min-width: 700px) {
        .dd {
            float: left;
            width: 100%
        }

        .dd + .dd {
            margin-left: 2%
        }
    }

    .dd-hover > .dd-handle {
        background: #2ea8e5 !important
    }

    .dd3-content {
        display: block;
        height: 30px;
        margin: 5px 0;
        padding: 5px 10px 5px 40px;
        color: #333;
        text-decoration: none;
        font-weight: bold;
        border: 1px solid #ccc;
        background: #fafafa;
        background: -webkit-linear-gradient(top, #fafafa 0, #eee 100%);
        background: -moz-linear-gradient(top, #fafafa 0, #eee 100%);
        background: linear-gradient(top, #fafafa 0, #eee 100%);
        -webkit-border-radius: 3px;
        border-radius: 3px;
        box-sizing: border-box;
        -moz-box-sizing: border-box
    }

    .dd3-content:hover {
        color: #2ea8e5;
        background: #fff
    }

    .dd-dragel > .dd3-item > .dd3-content {
        margin: 0
    }

    .dd3-item > button {
        margin-left: 30px
    }

    .dd3-handle {
        position: absolute;
        margin: 0;
        left: 0;
        top: 0;
        cursor: pointer;
        width: 30px;
        text-indent: 100%;
        white-space: nowrap;
        overflow: hidden;
        border: 1px solid #aaa;
        background: #ddd;
        background: -webkit-linear-gradient(top, #ddd 0, #bbb 100%);
        background: -moz-linear-gradient(top, #ddd 0, #bbb 100%);
        background: linear-gradient(top, #ddd 0, #bbb 100%);
        border-top-right-radius: 0;
        border-bottom-right-radius: 0
    }

    .dd3-handle:before {
        content: '≡';
        display: block;
        position: absolute;
        left: 0;
        top: 3px;
        width: 100%;
        text-align: center;
        text-indent: 0;
        color: #fff;
        font-size: 20px;
        font-weight: normal
    }

    .dd3-handle:hover {
        background: #ddd
    }

</style>
<div class="layui-fluid" lay-title="权限管理">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md6">
            <form class="layui-card layui-form" layui-filter="add-auth">
                <div class="layui-card-header">添加权限 <a href="#/icon/index" class="layui-btn layui-btn-xs">icon</a></div>
                <div class="layui-card-body layui-row layui-col-space10">

                    <p>
                        <span class="layui-badge-dot layui-bg-black"></span>
                        菜单、按钮权限会在登陆时返回给前端，api权限会在用户请求时判断操作权限
                    </p>
                    <div class="layui-col-md12">
                        <input type="text" name="auth_name" placeholder="权限名" autocomplete="off" lay-verify="required" class="layui-input">
                    </div>
                    <div class="layui-col-md6">
                        <input type="text" name="auth_rules" placeholder="权限标识,菜单/api权限为url"  lay-verify="required" autocomplete="off"
                               class="layui-input">
                    </div>
                    <div class="layui-col-md6">
                        <input type="text" name="auth_icon" placeholder="layui图标,首级菜单权限有效" autocomplete="off"
                               class="layui-input">
                    </div>
                    <div class="layui-form-item">
                        <input type="radio" name="auth_type" value="1" title="菜单" checked>
                        <input type="radio" name="auth_type" value="2" title="按钮">
                        <input type="radio" name="auth_type" value="3" title="api">
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button class="layui-btn" lay-submit lay-filter="add-auth">立即提交</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="layui-col-md6">
            <div class="layui-card">
                <div class="layui-card-header">权限排序</div>
                <div class="layui-card-body layui-row layui-col-space10">
                    <p>
                        <span class="layui-badge-dot layui-bg-orange"></span>
                        排序决定菜单类型权限显示，其他只为分类好区分
                        <button id="save_menu" class="layui-btn layui-btn-xs">保存排序</button>
                    </p>
                    <div class="dd" id="auth_list_bd">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script id="auth_list_tpl" type="text/html">
    {{#
    function siam(data,index){
        if(!data || data.length === 0) return '';
        var html = '<ol class="dd-list">';
        layui.each(data,function(i,item){
            html += '<li class="dd-item" data-id="' + item.auth_id+ '">';
                html += '<div class="dd-handle">' + item.auth_name+ '</div>';
                if(item.childs) html += siam(item.childs,index+1);
                html += '</li>';
            });
            html += "</ol>";
        return html;
        };
    }}
    {{ siam(d, 1) }}

</script>


<script>
    layui.use(['admin', 'form', 'jquery', 'nestable', 'laytpl'], function (admin, form) {
        var $ = layui.jquery;
        var element = layui.element;
        var nestable = layui.nestable;
        var laytpl = layui.laytpl;

        $('.dd').nestable();

        $("#save_menu").on('click', function () {
            let menu = $('.dd').nestable('serialize');
            // 保存权限列表
            admin.post({
                api: 'saveAuthList',
                data: {
                    order: JSON.stringify(menu)
                },
                success: function (res) {
                    layui.view.tab.refresh();
                }
            })

        });

        form.render();
        element.render('breadcrumb', 'breadcrumb');

        form.on('submit(add-auth)', function (data) {
            admin.post({
                api: "addAuth",
                data: data.field,
                success: function (res) {
                    layer.alert('添加成功',{
                        yes:function () {
                            layui.view.tab.refresh();
                            layer.closeAll();
                        }
                    });
                }
            });
            return false;
        });

        // 加载右侧权限列表
        admin.post({
            api: 'getAuthList',
            success: function (res) {
                let tpl = $("#auth_list_tpl").html();
                laytpl(tpl).render(res.result, function (html) {
                    $("#auth_list_bd").html(html);
                });
            }
        });

    });
</script>
